name: Production Deployment

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: "studypuck (Production)"  # Use existing environment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Validate migration safety
        run: |
          cd packages/database
          # Check for destructive operations
          if grep -r "DROP\|ALTER.*DROP\|TRUNCATE" migrations/ 2>/dev/null; then
            echo "‚ùå Destructive migration detected - manual review required"
            exit 1
          fi
          echo "‚úÖ Migration safety validated"
      
      - name: Create rollback point
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          npx neonctl branches create --name production-backup-$TIMESTAMP --parent production || echo "‚ö†Ô∏è Backup creation failed - proceeding"
          echo "ROLLBACK_BRANCH=production-backup-$TIMESTAMP" >> $GITHUB_ENV
      
      # Phase 1: Database Migration (BEFORE code deployment)
      - name: Apply migrations to production database
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          cd packages/database
          pnpm migrate:apply
          echo "‚úÖ Production database migrations applied"
      
      # Phase 2: Code deployment happens automatically via Cloudflare
      - name: Wait for Cloudflare deployment
        run: |
          echo "Waiting for Cloudflare Pages auto-deployment to complete..."
          sleep 45
      
      # Phase 3: Health verification
      - name: Verify production deployment
        run: |
          echo "üè• Testing production health endpoints..."
          
          # Test main site
          curl -f https://studypuck.app/ || exit 1
          echo "‚úÖ Main site responding"
          
          # Test health endpoint
          curl -f https://studypuck.app/api/health || exit 1
          echo "‚úÖ Health endpoint responding"
          
          echo "üéâ Production deployment verified"
      
      # Phase 4: Delete feature Neon branch (must run before development sync)
      - name: Delete merged feature Neon branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          # Derive the source branch name from the merge commit
          MERGED_BRANCH=$(git log -1 --merges --pretty=format:"%s" | grep -oP "(?<=Merge pull request #\d+ from [^/]+/)\S+" || true)
          if [ -z "$MERGED_BRANCH" ]; then
            # Fallback: try the second parent of the merge commit
            MERGED_BRANCH=$(git log -1 --pretty=format:"%P" | awk '{print $2}' | xargs -I{} git name-rev --name-only {} 2>/dev/null | sed 's|remotes/origin/||' || true)
          fi
          echo "Detected merged branch: ${MERGED_BRANCH:-unknown}"
          if [ -n "$MERGED_BRANCH" ] && [ "$MERGED_BRANCH" != "unknown" ]; then
            echo "üóëÔ∏è Attempting to delete Neon branch: $MERGED_BRANCH"
            npx neonctl branches delete "$MERGED_BRANCH" || echo "‚ÑπÔ∏è Neon branch '$MERGED_BRANCH' not found or already deleted ‚Äî skipping"
          else
            echo "‚ÑπÔ∏è Could not determine merged branch name ‚Äî skipping Neon branch deletion"
          fi

      # Phase 5: Development sync (Last Possible Moment)
      - name: Sync development branch
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          echo "üìã Syncing development branch to production state..."
          npx neonctl branches reset development --parent
          echo "‚úÖ Development branch synced to production state"
      
      # Rollback on failure
      - name: Rollback on failure
        if: failure()
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
        run: |
          if [ -n "$ROLLBACK_BRANCH" ]; then
            echo "üîÑ Rolling back production database..."
            # Note: Manual rollback required - reset to backup branch through Neon console
            echo "‚ö†Ô∏è Automatic rollback not implemented - please manually reset production to: $ROLLBACK_BRANCH"
          fi