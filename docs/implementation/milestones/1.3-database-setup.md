# Milestone 1.3: Database Setup

**Goal**: Connect to Cloudflare D1, create user profiles  
**Status**: ðŸ“‹ Planned  
**Dependencies**: Milestone 1.2 complete (authentication working)  
**Reference**: `/docs/specs/database-schema-design.md`

## Milestone Overview

Connect StudyPuck to Cloudflare D1 database and implement basic user profile management:
- Create and configure Cloudflare D1 database
- Deploy initial schema (users table)
- Connect SvelteKit app to D1
- Auto-create user profiles on first login
- Display user information on authenticated pages

## Prerequisites

- [ ] Milestone 1.2 complete (Auth0 authentication working)
- [ ] Users can successfully login/logout on studypuck.app

## Manual Setup Requirements

### Cloudflare D1 Database
1. **Create D1 database**
   ```bash
   npx wrangler d1 create studypuck-db
   ```

2. **Add to wrangler.toml** (create file in `/apps/web/`)
   ```toml
   name = "studypuck-web"
   main = "build/index.js"
   compatibility_date = "2023-12-01"
   
   [[d1_databases]]
   binding = "DB"
   database_name = "studypuck-db"
   database_id = "<your-database-id>"
   ```

3. **Configure local development**
   ```bash
   npx wrangler d1 create studypuck-db-local --local
   ```

### Initial Schema Deployment

1. **Create schema file** (`schema/001-users.sql`)
   ```sql
   -- Initial user profiles table
   CREATE TABLE users (
     id TEXT PRIMARY KEY,
     auth0_id TEXT UNIQUE NOT NULL,
     email TEXT UNIQUE NOT NULL,
     name TEXT,
     picture_url TEXT,
     created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
     last_login DATETIME DEFAULT CURRENT_TIMESTAMP
   );
   
   CREATE INDEX idx_users_auth0_id ON users(auth0_id);
   CREATE INDEX idx_users_email ON users(email);
   ```

2. **Deploy schema**
   ```bash
   # Local
   npx wrangler d1 execute studypuck-db-local --local --file=schema/001-users.sql
   
   # Production  
   npx wrangler d1 execute studypuck-db --file=schema/001-users.sql
   ```

## Implementation Tasks

### Task 1: Database Integration Setup

1. **Add D1 types and utilities**
   ```bash
   cd apps/web
   pnpm add drizzle-orm
   pnpm add -D drizzle-kit
   ```

2. **Create database utilities**
   - `src/lib/db/schema.ts` - Drizzle schema definitions
   - `src/lib/db/index.ts` - Database client setup
   - `src/lib/db/users.ts` - User database operations

### Task 2: User Profile Management

1. **Create user service**
   - Function to create user profile from Auth0 data
   - Function to get user profile by Auth0 ID
   - Function to update user profile

2. **Integrate with auth flow**
   - Modify auth hooks to check/create user profile
   - Auto-create profile on first successful login
   - Load user profile data in layout

### Task 3: Update UI with User Data

1. **Enhanced user display**
   - Show user name and avatar (if available)
   - Display account creation date
   - Show last login timestamp

2. **Create profile page** (simple)
   - Basic user information display
   - Demonstrates database integration working

### Task 4: Database Schema Management

1. **Migration system setup**
   - Create migration file structure
   - Add migration scripts to package.json
   - Document schema deployment process

2. **Development workflow**
   - Local D1 database for development
   - Schema sync between local and production

## Success Criteria

- [ ] **D1 database created** and accessible
- [ ] **User schema deployed** to both local and production
- [ ] **User profiles auto-created** on first login
- [ ] **User data displayed** on authenticated pages
- [ ] **Database isolation works**: Each user sees only their data
- [ ] **Local development**: Database works in development environment
- [ ] **Production deployment**: Database works on studypuck.app

## Verification Steps

1. **Schema Verification**
   ```bash
   # Check tables exist
   npx wrangler d1 execute studypuck-db --command="SELECT name FROM sqlite_master WHERE type='table';"
   ```

2. **User Flow Testing**
   - Login with new user â†’ profile should be auto-created
   - Check user data displays correctly
   - Login with existing user â†’ existing profile should be used
   - Verify profile data persists across sessions

3. **Database Testing**
   ```bash
   # Check user was created
   npx wrangler d1 execute studypuck-db --command="SELECT * FROM users;"
   ```

## Files Created/Modified

- `apps/web/wrangler.toml` - Cloudflare Workers configuration
- `apps/web/schema/001-users.sql` - Initial database schema
- `apps/web/src/lib/db/schema.ts` - Drizzle schema definitions
- `apps/web/src/lib/db/index.ts` - Database client
- `apps/web/src/lib/db/users.ts` - User database operations
- `apps/web/src/hooks.server.ts` - Updated with user profile logic
- `apps/web/src/routes/+layout.server.ts` - Load user profile data
- `apps/web/src/routes/profile/+page.svelte` - Simple profile page

## Next Phase

Upon completion: Begin Phase 2 - Core Language Learning Features

**Milestone 2.1**: Card Management (create, view, edit language learning cards)