# Milestone 1.2: Authentication Integration

**Goal**: Working login/logout flow using Auth0 + Auth.js  
**Status**: ðŸ“‹ Planned  
**Dependencies**: Milestone 1.1 complete  
**Reference**: `/docs/specs/auth-implementation-plan.md`

## Milestone Overview

Add authentication to StudyPuck using Auth0 as the identity provider and Auth.js for session management:
- Install and configure Auth.js for SvelteKit
- Set up Auth0 as OpenID Connect provider
- Add login/logout UI components
- **Implement Zod schemas** for auth-related data validation
- Deploy with environment variables
- Test authentication flow on studypuck.app

## Prerequisites

- [ ] Milestone 1.1 complete (monorepo + basic SvelteKit app deployed)
- [ ] studypuck.app loading successfully

## Manual Setup Requirements

### Auth0 Setup
1. **Create Auth0 tenant** (if not already existing)
2. **Create Single Page Application** in Auth0
3. **Configure application URLs**:
   - Allowed Callback URLs: `https://studypuck.app/auth/callback/auth0`
   - Allowed Logout URLs: `https://studypuck.app`
   - Allowed Web Origins: `https://studypuck.app`
4. **Note credentials**: Domain, Client ID, Client Secret

### Environment Variables
Add to Cloudflare Pages environment variables:
```
AUTH_SECRET=<generate-random-secret>
AUTH0_ID=<your-auth0-client-id>
AUTH0_SECRET=<your-auth0-client-secret>
AUTH0_DOMAIN=<your-auth0-domain>
AUTH0_ISSUER=https://<your-auth0-domain>
```

## Implementation Tasks

### Task 1: Install Dependencies

1. **Add Auth.js and Zod dependencies**
   ```bash
   cd apps/web
   pnpm add @auth/core @auth/sveltekit zod
   ```

2. **Create auth configuration**
   - Create `src/lib/auth.ts` with Auth0 provider configuration
   - Configure session strategy and callbacks

3. **Create Zod validation schemas**
   - Create `src/lib/schemas/auth.ts` with user and session schemas
   - Validate Auth0 responses and session data

### Task 2: Configure SvelteKit Integration

1. **Add auth hook**
   - Create `src/hooks.server.ts` with Auth.js handle
   - Set up session management

2. **Create auth routes**
   - Auth.js automatically handles `/auth/*` routes
   - Verify callback and logout routes work

### Task 3: Add Authentication UI

1. **Create auth components**
   - Login button component
   - Logout button component  
   - User profile display component

2. **Update main page**
   - Add authentication status display
   - Show different content for authenticated/unauthenticated users
   - Add login/logout buttons

3. **Create protected page** (optional)
   - Simple dashboard/profile page
   - Demonstrates authentication protection

### Task 4: Environment Configuration

1. **Local development**
   - Create `.env.local` with development Auth0 config
   - Test auth flow locally

2. **Production deployment**
   - Add environment variables to Cloudflare Pages
   - Configure production Auth0 application

## Success Criteria

- [ ] **Login flow works**: Users can sign in with Auth0
- [ ] **Logout flow works**: Users can sign out and session is cleared
- [ ] **Session persistence**: Users stay logged in across page reloads
- [ ] **Protected routes**: Can protect pages requiring authentication
- [ ] **Production deployment**: Auth works on studypuck.app
- [ ] **Local development**: Auth works in development environment

## Verification Steps

1. **Local Testing**
   ```bash
   pnpm turbo dev --filter=web
   # Visit localhost:5173, test login/logout flow
   ```

2. **Production Testing**
   - Visit `https://studypuck.app`
   - Click "Sign In" â†’ redirects to Auth0
   - Complete authentication â†’ redirects back with session
   - Verify user is shown as logged in
   - Click "Sign Out" â†’ session cleared

## Files Created/Modified

- `apps/web/src/lib/auth.ts` - Auth.js configuration
- `apps/web/src/lib/schemas/auth.ts` - Zod validation schemas for auth data
- `apps/web/src/hooks.server.ts` - SvelteKit auth integration
- `apps/web/src/lib/components/AuthButton.svelte` - Login/logout component
- `apps/web/src/routes/+page.svelte` - Updated with auth UI
- `apps/web/src/routes/+layout.server.ts` - Session data loading with validation
- `.env.local` - Local development environment variables

## Next Milestone

Upon completion: [Milestone 1.3: Database Setup](1.3-database-setup.md)