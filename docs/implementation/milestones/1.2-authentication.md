# Milestone 1.2: Authentication Integration

**Goal**: Working login/logout flow using Auth0 + Auth.js  
**Status**: üîß Fixing environment variables in Cloudflare deployment  
**Dependencies**: Milestone 1.1 complete ‚úÖ  
**Reference**: `/docs/specs/auth-implementation-plan.md`

## Current Status

**Auth.js Implementation**: ‚úÖ Complete and functional locally
- ‚úÖ Login flow working with Auth0
- ‚úÖ Session management functional  
- ‚úÖ UI components built (AuthButton.svelte)
- ‚úÖ Zod schemas for validation
- ‚úÖ Multi-hop logout workaround functional
- üîß **Current Issue**: Environment variable access in Cloudflare Pages

**Deployment Challenge**: Cloudflare Pages runtime environment differences
- Local development: Working with .env files
- Cloudflare Pages: "process is not defined" errors
- Multiple approaches attempted for environment variable access

## Milestone Overview

Add authentication to StudyPuck using Auth0 as the identity provider and Auth.js for session management:
- Install and configure Auth.js for SvelteKit
- Set up Auth0 as OpenID Connect provider
- Add login/logout UI components
- **Implement Zod schemas** for auth-related data validation
- Deploy with environment variables
- Test authentication flow on studypuck.app

## Prerequisites

- [ ] Milestone 1.1 complete (monorepo + basic SvelteKit app deployed)
- [ ] studypuck.app loading successfully

## Manual Setup Requirements

### Auth0 Setup
1. **Create Auth0 tenant** (if not already existing)
2. **Create Single Page Application** in Auth0
3. **Configure application URLs**:
   - Allowed Callback URLs: `https://studypuck.app/auth/callback/auth0`
   - Allowed Logout URLs: `https://studypuck.app`
   - Allowed Web Origins: `https://studypuck.app`
4. **Note credentials**: Domain, Client ID, Client Secret

### Environment Variables
Add to Cloudflare Pages environment variables:
```
AUTH_SECRET=<generate-random-secret>
AUTH0_ID=<your-auth0-client-id>
AUTH0_SECRET=<your-auth0-client-secret>
AUTH0_DOMAIN=<your-auth0-domain>
AUTH0_ISSUER=https://<your-auth0-domain>
```

## Implementation Tasks

### Migration Step 1: Quick Fix Current ZodError
1. **Diagnose Cloudflare deployment issue** - likely missing environment variables
2. **Verify Auth.js setup works** to unblock feature branch

### Migration Step 2: Better Auth Migration  
*Following official migration guides:*
- **Auth.js guide**: https://authjs.dev/getting-started/migrate-to-better-auth
- **Better Auth guide**: https://www.better-auth.com/docs/guides/next-auth-migration-guide

1. **Install Better Auth dependencies**
   ```bash
   cd apps/web
   pnpm remove @auth/core @auth/sveltekit
   pnpm add better-auth @better-auth/sveltekit
   ```

2. **Update auth configuration** - Preserve existing Zod schemas
   - Replace `src/lib/auth.ts` with Better Auth instance
   - Configure Auth0 as social provider
   - **Key benefit**: Native federated logout support (eliminates hacky workaround)

3. **Migration advantages over current Auth.js setup**:
   - **TypeScript-first**: Better integration with existing Zod schemas  
   - **Native logout**: Should eliminate multi-hop logout workaround
   - **SvelteKit optimized**: Modern patterns vs Auth.js legacy

### Migration Step 3: Update SvelteKit Integration

1. **Replace auth hook**
   - Update `src/hooks.server.ts` with Better Auth handle
   - **Expected improvement**: Cleaner session management

2. **Update auth routes**
   - Better Auth handles `/api/auth/*` routes  
   - **Remove hacky logout workaround**: Replace `/auth/logout` + `/auth/logout/final` 
   - **Use Better Auth native logout**: Single, clean federated logout flow

### Task 3: Add Authentication UI

1. **Create auth components**
   - Login button component
   - Logout button component  
   - User profile display component

2. **Update main page**
   - Add authentication status display
   - Show different content for authenticated/unauthenticated users
   - Add login/logout buttons

3. **Create protected page** (optional)
   - Simple dashboard/profile page
   - Demonstrates authentication protection

### Task 4: Environment Configuration

1. **Local development**
   - Create `.env.local` with development Auth0 config
   - Test auth flow locally

2. **Production deployment**
   - Add environment variables to Cloudflare Pages
   - Configure production Auth0 application

## Success Criteria

- [ ] **Login flow works**: Users can sign in with Auth0
- [ ] **Logout flow works**: Users can sign out and session is cleared
- [ ] **Session persistence**: Users stay logged in across page reloads
- [ ] **Protected routes**: Can protect pages requiring authentication
- [ ] **Production deployment**: Auth works on studypuck.app
- [ ] **Local development**: Auth works in development environment

## Verification Steps

1. **Local Testing**
   ```bash
   pnpm turbo dev --filter=web
   # Visit localhost:5173, test login/logout flow
   ```

2. **Production Testing**
   - Visit `https://studypuck.app`
   - Click "Sign In" ‚Üí redirects to Auth0
   - Complete authentication ‚Üí redirects back with session
   - Verify user is shown as logged in
   - Click "Sign Out" ‚Üí session cleared

## Files Created/Modified

### ‚úÖ Preserved from Auth.js Implementation (792 lines):
- `apps/web/src/lib/components/AuthButton.svelte` - Login/logout component (adapt to Better Auth)
- `apps/web/src/lib/schemas/auth.ts` - Zod validation schemas (compatible with Better Auth)
- `apps/web/src/routes/+page.svelte` - Updated with auth UI (minor adaptations needed)
- `apps/web/src/routes/+layout.server.ts` - Session data loading (update API calls)
- `.env.local` - Environment variables (mostly preserved)

### üîÑ Updated for Better Auth Migration:
- `apps/web/src/lib/auth.ts` - **Replace** Auth.js with Better Auth configuration
- `apps/web/src/hooks.server.ts` - **Replace** Auth.js handle with Better Auth
- `apps/web/package.json` - **Replace** dependencies

### ‚ùå Removed (Hacky Workarounds):
- `apps/web/src/routes/auth/logout/+server.ts` - **Delete** (replaced by Better Auth native)
- `apps/web/src/routes/auth/logout/final/+server.ts` - **Delete** (no longer needed)

### üìö Documentation Updates:
- Update milestone 1.2 status to reflect migration
- Document Better Auth benefits vs Auth.js issues
- Note federated logout improvement

## Next Milestone

Upon completion: [Milestone 1.3: Database Setup](1.3-database-setup.md)